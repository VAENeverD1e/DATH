{
  "info": {
    "_postman_id": "dath-api-tests",
    "name": "DATH API Tests",
    "description": "Complete API testing collection for DATH backend - Phase 1 fixes verification",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Register Patient",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Save token for future requests",
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.environment.set(\"token\", jsonData.token);",
                  "    pm.environment.set(\"userId\", jsonData.user.id);",
                  "    console.log(\"✅ Token saved\");",
                  "}",
                  "",
                  "// Verify response structure",
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test(\"Response has token\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('token');",
                  "    pm.expect(jsonData.token).to.be.a('string');",
                  "});",
                  "",
                  "pm.test(\"User object has required fields\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.user).to.have.property('id');",
                  "    pm.expect(jsonData.user).to.have.property('username');",
                  "    pm.expect(jsonData.user).to.have.property('role');",
                  "    pm.expect(jsonData.user.role).to.equal('patient');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"testpatient\",\n  \"email\": \"patient@test.com\",\n  \"password\": \"TestPass123!\",\n  \"phone_number\": \"1234567890\",\n  \"date_of_birth\": \"1990-01-15\",\n  \"address\": \"123 Main St\",\n  \"gender\": \"M\",\n  \"insurance_provider\": \"Blue Cross\",\n  \"insurance_number\": \"BC123456\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "register"]
            }
          }
        },
        {
          "name": "Login",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Login response has token and user\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('token');",
                  "    pm.expect(jsonData).to.have.property('user');",
                  "    pm.expect(jsonData.user.username).to.equal(pm.environment.get('username'));",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"testpatient\",\n  \"password\": \"TestPass123!\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "login"]
            }
          }
        },
        {
          "name": "Get Profile (/me) - JWT Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// THIS TEST VERIFIES JWT FIX",
                  "pm.test(\"✅ JWT payload fix verified - Status 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"✅ No 'invalid token payload' error\", function () {",
                  "    var responseBody = pm.response.text();",
                  "    pm.expect(responseBody).to.not.include('invalid token payload');",
                  "});",
                  "",
                  "pm.test(\"✅ User profile loaded with patient data\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.user).to.have.property('id');",
                  "    pm.expect(jsonData.user).to.have.property('username');",
                  "    pm.expect(jsonData.user).to.have.property('patient');",
                  "    pm.expect(jsonData.user.patient).to.have.property('insurance_provider');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/me",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "me"]
            }
          }
        },
        {
          "name": "Invalid Token Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 401 for invalid token\", function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test(\"Error message present\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.error).to.exist;",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer invalid_token_xyz"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/me",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "me"]
            }
          }
        },
        {
          "name": "Duplicate Registration Test",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 409 for duplicate username\", function () {",
                  "    pm.response.to.have.status(409);",
                  "});",
                  "",
                  "pm.test(\"Error message for duplicate\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.error).to.include('already exists');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"testpatient\",\n  \"password\": \"TestPass123!\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": ["{{baseUrl}}"],
              "path": ["api", "auth", "register"]
            }
          }
        }
      ]
    },
    {
      "name": "Departments",
      "item": [
        {
          "name": "Get All Departments",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/departments",
              "host": ["{{baseUrl}}"],
              "path": ["api", "departments"]
            }
          }
        },
        {
          "name": "Create Department (Admin)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.environment.set(\"deptId\", jsonData.department_id);",
                  "    console.log(\"Department ID saved\");",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Cardiology\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/departments",
              "host": ["{{baseUrl}}"],
              "path": ["api", "departments"]
            }
          }
        },
        {
          "name": "Update Department - No Description Field (FIX TEST)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// THIS TEST VERIFIES DESCRIPTION FIELD FIX",
                  "pm.test(\"✅ Description field fix verified - Status 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"✅ Update succeeds without description field error\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.department_id).to.exist;",
                  "    pm.expect(jsonData.name).to.equal('Updated Cardiology');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Updated Cardiology\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/departments/1",
              "host": ["{{baseUrl}}"],
              "path": ["api", "departments", "1"]
            }
          }
        },
        {
          "name": "Delete Department",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/departments/1",
              "host": ["{{baseUrl}}"],
              "path": ["api", "departments", "1"]
            }
          }
        }
      ]
    },
    {
      "name": "Appointments",
      "item": [
        {
          "name": "Get My Appointments (Variable Bug Fix Test)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// THIS TEST VERIFIES APPOINTMENTS VARIABLE BUG FIX",
                  "pm.test(\"✅ Variable bug fix verified - Status 200\", function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"✅ No 'Cannot read property' error\", function () {",
                  "    var responseBody = pm.response.text();",
                  "    pm.expect(responseBody).to.not.include('Cannot read property');",
                  "});",
                  "",
                  "pm.test(\"✅ Response is array (empty or with appointments)\", function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/appointments/my",
              "host": ["{{baseUrl}}"],
              "path": ["api", "appointments", "my"]
            }
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    },
    {
      "key": "token",
      "value": ""
    },
    {
      "key": "userId",
      "value": ""
    },
    {
      "key": "deptId",
      "value": ""
    }
  ]
}
